// Fill out your copyright notice in the Description page of Project Settings.

#pragma once

#include "CoreMinimal.h"
#include "SmithEnemy.h"
#include "ISmithAnimator.h"
#include "ISmithSimpleAIDriven.h"
#include "../Weapon/Params.h"
#include "ICanRequestEventPublishment.h"
#include "SmithAIConditionBindHandle.h"
#include "ISmithBattleLogger.h"
#include "SmithEnemyTraits.h"
#include "IAttackCauser.h"

#include "SmithBoss.generated.h"

class USmithAIConditionAttackStrategy;
class USmithTurnBaseAIMoveStrategy;
class USmithTurnBaseAIIdleStrategy;
class USmithBattleLogWorldSubsystem;

class USmithAnimationComponent;

struct FSmithAIStrategyContainer;

// TODO
struct FSmithAIConditionBindHandle;

class ASmithDangerZoneDisplayer;

DECLARE_DELEGATE_RetVal(bool,FConditionDelegate);

/**
 *
 */
UCLASS()
class SMITH_API ASmithBoss final: public ASmithEnemy, public ISmithSimpleAIDriven,
                                  public ICanRequestEventPublishment, public ISmithBattleLogger,
                                  public ISmithAnimator, public IAttackCauser
{
  GENERATED_BODY()

public:
  using Type = typename Dragon;

public:

  ASmithBoss();

protected:
  void BeginPlay() override final;
  void EndPlay(const EEndPlayReason::Type EndPlayReason) override final;

public:
  void Tick(float DeltaTime) override final;

public:
  //---Begin of IAttackable Interface
  void OnAttack(const AttackHandle& Handle) override final;
  bool IsDefeated() const override final;
  void OnDefeated() override final;

  void TurnOnAI() override final;

  void SwitchAnimation(uint8 animationState) override;
  void UpdateAnimation(float deltaTime) override;
  bool IsAnimationFinish() const override;

public:
  FString GetName_Log() const override;
	EBattleLogType GetType_Log() const override;

  void InitializeParameter(int32 currentLevel) override final;

  void OnAttackExecuted() override
  {
  }

// その技を使う条件の関数
private:
  bool RageCondition();
  UFUNCTION()
  bool WingsCondition();
  UFUNCTION()
  bool BreathCondition();
  UFUNCTION()
  bool PressCondition();
  bool NormalCondition();

public:
  void SetEventPublishMediator(IEventPublishMediator *) override;

private:

  UPROPERTY()
  TObjectPtr<USmithAIConditionAttackStrategy> m_attackStrategy;

  UPROPERTY()
  TObjectPtr<USmithTurnBaseAIMoveStrategy> m_moveStrategy;

  UPROPERTY()
  TObjectPtr<USmithTurnBaseAIIdleStrategy> m_idleStrategy;

  UPROPERTY(EditAnywhere)
  TObjectPtr<USmithAnimationComponent> AnimComponent;

  // Attack Format
  UPROPERTY(EditAnywhere, BlueprintReadOnly, Category = AttackFormat, meta = (AllowPrivateAccess = "true"))
  TMap<FString, FSmithAIConditionBindHandle> ConditionAttackFormatTables;

private:
  UPROPERTY(EditAnywhere, BlueprintReadOnly, Category = BattleParameter, meta = (AllowPrivateAccess = "true"))
  FParams EnemyParam;
  UPROPERTY(EditAnywhere)
  FString Name;

  TWeakInterfacePtr<IEventPublishMediator> m_eventMediator;

private:
  int32 m_maxHp;
  int32 m_level;
  int32 m_wingsCnt;
  int32 m_breathCnt;
  int32 m_sweepCnt;
  bool m_isRage;
};
